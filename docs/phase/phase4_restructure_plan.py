"""
Phase 4: êµ¬ì¡° ì¬ì„¤ê³„ ê³„íš

ì˜ë£Œê¸°ê¸°(SaMD) ì „í™˜ì„ ìœ„í•œ êµ¬ì¡° íŒŒê´´ ë° ì¬ê±´ì¶•
"""

from typing import Dict, List, Optional
from datetime import datetime
from pathlib import Path
import json


class SaMDArchitectureRestructure:
    """
    SaMD ì•„í‚¤í…ì²˜ ì¬ì„¤ê³„ í´ë˜ìŠ¤
    
    ê·œì œ ê¸°ì¤€ì— ë§ëŠ” êµ¬ì¡°ë¡œ ì „ë©´ ì¬ì„¤ê³„
    """
    
    def __init__(self):
        """ì¬ì„¤ê³„ ê³„íš ì´ˆê¸°í™”"""
        self.restructure_plan = {
            'phase_4a': {
                'name': 'ì•½ë¬¼-íŒë‹¨ ì§ê²° êµ¬ì¡° íŒŒê´´',
                'priority': 'critical',
                'duration': '2-3ê°œì›”',
                'tasks': [
                    'PK/PD ëª¨ë“ˆ Sandbox ê²©ë¦¬',
                    'ì¸ì§€ ë°˜ì‘ì„± ë§¤ê°œ ë³€ìˆ˜ ë„ì…',
                    'CDSS êµ¬ì¡°ë¡œ ì „í™˜',
                    'ì˜ì‚¬ ê°œì… ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€'
                ]
            },
            'phase_4b': {
                'name': 'FHIR Semantic Binding',
                'priority': 'critical',
                'duration': '1-2ê°œì›”',
                'tasks': [
                    'Provenance ë¦¬ì†ŒìŠ¤ ê°•ì œ ìƒì„±',
                    'Device ë¦¬ì†ŒìŠ¤ ìƒì„± (UDI)',
                    'LOINC ì½”ë“œ Semantic Validator',
                    'Clinical Context í•„ìˆ˜í™”'
                ]
            },
            'phase_4c': {
                'name': 'QMS ê¸°ë°˜ ê°œë°œ',
                'priority': 'critical',
                'duration': '2-3ê°œì›”',
                'tasks': [
                    'ì½”ë“œ ë³€ê²½ ì‹œ ìë™ ìœ„í—˜ ë¶„ì„',
                    'Audit Trail ìë™ ê¸°ë¡',
                    'QMS ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸',
                    'ê°œë°œ ê³¼ì • = ê·œì œ ë¬¸ì„œ êµ¬ì¡°'
                ]
            }
        }
    
    def generate_restructure_report(self) -> str:
        """
        ì¬ì„¤ê³„ ê³„íš ë¦¬í¬íŠ¸ ìƒì„±
        
        Returns:
            ë¦¬í¬íŠ¸ í…ìŠ¤íŠ¸
        """
        report = f"""
================================================================================
Phase 4: êµ¬ì¡° ì¬ì„¤ê³„ ê³„íš
================================================================================

ìƒì„± ì¼ì: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

================================================================================
ğŸ¯ ëª©í‘œ
================================================================================

"ì˜ë£Œê¸°ê¸° í‰ë‚´" â†’ "ì‹¤ì œ ì˜ë£Œê¸°ê¸°" ì „í™˜

í˜„ì¬ ì¤€ìˆ˜ë„: 60%
ëª©í‘œ ì¤€ìˆ˜ë„: 88%
í•„ìš” ê¸°ê°„: 5-8ê°œì›”

================================================================================
ğŸ”¨ ë¶€ìˆ´ì•¼ í•  êµ¬ì¡° (3ê°€ì§€)
================================================================================

1. ì•½ë¬¼-íŒë‹¨ ì§ê²° êµ¬ì¡°
   í˜„ì¬: ì•½ë¬¼ íš¨ê³¼ â†’ ì§ì ‘ ADHD ì ìˆ˜
   ë¬¸ì œ: ë¸”ë™ë°•ìŠ¤í˜• ìœ„í—˜ ì‹œìŠ¤í…œ
   í•´ê²°: Sandbox ê²©ë¦¬ + CDSS êµ¬ì¡°

2. í˜•ì‹ì  FHIR
   í˜„ì¬: íƒ€ì…ë§Œ ë§ì¶˜ FHIR ë¦¬ì†ŒìŠ¤
   ë¬¸ì œ: Provenance ë¶€ì¬, Semantic Binding ì—†ìŒ
   í•´ê²°: Provenance ê°•ì œ + Device ë¦¬ì†ŒìŠ¤ + Validator

3. ë¬¸ì„œ ìƒì„± ì‹œìŠ¤í…œ
   í˜„ì¬: ì‚¬í›„ ë¬¸ì„œ ìƒì„±
   ë¬¸ì œ: ê°œë°œ ê³¼ì • ê¸°ë¡ ì—†ìŒ
   í•´ê²°: ì½”ë“œ ë³€ê²½ â†’ ìë™ ìœ„í—˜ ë¶„ì„ â†’ Audit Trail â†’ QMS

================================================================================
ğŸ“‹ Phaseë³„ ì‘ì—… ê³„íš
================================================================================

"""
        
        for phase_id, phase_info in self.restructure_plan.items():
            report += f"""
{phase_info['name']} ({phase_id.upper()})
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ìš°ì„ ìˆœìœ„: {phase_info['priority'].upper()}
ì˜ˆìƒ ê¸°ê°„: {phase_info['duration']}

ì‘ì—… í•­ëª©:
"""
            for i, task in enumerate(phase_info['tasks'], 1):
                report += f"  {i}. {task}\n"
            report += "\n"
        
        report += """
================================================================================
âš ï¸ ê²½ê³ 
================================================================================

ì´ ì¬ê±´ì¶•ì€ "ê°œì„ "ì´ ì•„ë‹ˆë¼ "íŒŒê´´ í›„ ì¬ê±´"ì…ë‹ˆë‹¤.

- ê¸°ì¡´ ì½”ë“œì˜ 30-40%ëŠ” ì™„ì „íˆ ì¬ì‘ì„± í•„ìš”
- ì•„í‚¤í…ì²˜ ì „ë©´ ë³€ê²½
- API í˜¸í™˜ì„± ê¹¨ì§

í•˜ì§€ë§Œ:
- ê·œì œ ìŠ¹ì¸ ê°€ëŠ¥í•œ êµ¬ì¡°
- ë³‘ì› EHR ì—°ë™ ê°€ëŠ¥
- ì‹¤ì œ ì˜ë£Œê¸°ê¸°ë¡œ ì „í™˜ ê°€ëŠ¥

================================================================================
ğŸ¯ ê²°ë¡ 
================================================================================

í˜„ì¬: "ì˜ë£Œê¸°ê¸° í‰ë‚´" (60%)
ì¬ê±´ì¶• í›„: "ì‹¤ì œ ì˜ë£Œê¸°ê¸°" (88%)

ì„ íƒì§€:
1. âœ… ì¬ê±´ì¶• ì§„í–‰ â†’ ì˜ë£Œê¸°ê¸° ëª©í‘œ (12-18ê°œì›”)
2. âš ï¸ í˜„ì¬ êµ¬ì¡° ìœ ì§€ â†’ ì—°êµ¬ í”Œë«í¼ìœ¼ë¡œ ê³ ì • (3-6ê°œì›”)

ê¶Œì¥: ì¬ê±´ì¶• ì§„í–‰

"êµ¬ì¡°ë¥¼ ë¶€ìˆ˜ì§€ ì•Šìœ¼ë©´, ê·œì œê¸°ê´€ì´ ë¶€ìˆ´ì¤„ ê²ƒì´ë‹¤."

================================================================================
"""
        
        return report
    
    def save_restructure_plan(self, output_path: Path):
        """
        ì¬ì„¤ê³„ ê³„íš ì €ì¥
        
        Args:
            output_path: ì¶œë ¥ íŒŒì¼ ê²½ë¡œ
        """
        report = self.generate_restructure_report()
        output_path.write_text(report, encoding='utf-8')
        
        # JSON í˜•ì‹ìœ¼ë¡œë„ ì €ì¥
        json_path = output_path.with_suffix('.json')
        with open(json_path, 'w', encoding='utf-8') as f:
            json.dump(self.restructure_plan, f, indent=2, ensure_ascii=False)


if __name__ == "__main__":
    restructure = SaMDArchitectureRestructure()
    report = restructure.generate_restructure_report()
    print(report)

