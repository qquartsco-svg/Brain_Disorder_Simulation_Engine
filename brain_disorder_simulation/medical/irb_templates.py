"""
IRB 제출 준비 템플릿

연구 윤리위원회(Institutional Review Board) 제출용 문서 템플릿
"""

from typing import Dict, Optional
from datetime import datetime
from pathlib import Path


class IRBTemplateGenerator:
    """
    IRB 제출 문서 생성기
    
    연구 계획서, 동의서, 데이터 보호 계획 등 생성
    """
    
    def __init__(self, output_dir: Optional[Path] = None):
        """
        IRB 템플릿 생성기 초기화
        
        Args:
            output_dir: 출력 디렉토리
        """
        self.output_dir = output_dir or Path.cwd() / 'irb_documents'
        self.output_dir.mkdir(exist_ok=True)
    
    def generate_research_protocol(self,
                                  principal_investigator: str,
                                  institution: str,
                                  study_title: str,
                                  study_duration_months: int = 12,
                                  participant_count: int = 100) -> str:
        """
        연구 계획서 생성
        
        Args:
            principal_investigator: 연구 책임자 이름
            institution: 소속 기관
            study_title: 연구 제목
            study_duration_months: 연구 기간 (개월)
            participant_count: 참가자 수
        
        Returns:
            연구 계획서 텍스트
        """
        protocol = f"""
================================================================================
연구 계획서 (Research Protocol)
================================================================================

연구 제목: {study_title}
연구 책임자: {principal_investigator}
소속 기관: {institution}
작성 일자: {datetime.now().strftime('%Y-%m-%d')}

================================================================================
1. 연구 배경 및 목적
================================================================================

1.1 연구 배경
본 연구는 Cookiie Brain Engine 기반 ADHD 시뮬레이션 시스템의 
임상 연구 보조 도구로서의 유용성을 검증하기 위한 것입니다.

1.2 연구 목적
- ADHD 시뮬레이션 시스템의 정확도 및 일관성 검증
- 정상 참조군과의 비교 분석
- DSM-5 및 ICD-11 기준과의 매핑 정확도 평가

1.3 연구 가설
- 시뮬레이션 결과가 전문의 평가와 유의미한 상관관계를 보일 것
- 정상 참조군과의 차이가 통계적으로 유의미할 것

================================================================================
2. 연구 방법
================================================================================

2.1 연구 설계
- 전향적 관찰 연구 (Prospective Observational Study)
- 단면 연구 (Cross-sectional Study)

2.2 참가자 선정 기준

포함 기준:
- 만 12세 이상
- ADHD 평가를 받을 의사가 있는 자
- 연구 참여에 동의한 자

제외 기준:
- 심각한 정신질환 (조현병, 양극성 장애 등)
- 인지 장애
- 연구 참여에 부적합한 기타 의학적 상태

2.3 연구 절차
1. 연구 설명 및 동의서 서명
2. 기본 정보 수집 (연령, 성별 등)
3. ADHD 시뮬레이션 실행
4. 전문의 평가 (독립적으로 수행)
5. 결과 비교 분석

2.4 데이터 수집
- 시뮬레이션 결과 (주의력, 충동성, 과잉행동 점수)
- 전문의 평가 결과
- 기본 인구통계학적 정보

================================================================================
3. 윤리적 고려사항
================================================================================

3.1 위험 및 이익
- 최소 위험 연구 (Minimal Risk Research)
- 직접적 이익 없음
- 사회적 이익: ADHD 평가 도구 개발

3.2 개인정보 보호
- 모든 데이터 익명화
- 암호화된 저장
- 접근 권한 제한

3.3 동의 철회
- 언제든지 동의 철회 가능
- 철회 시 데이터 삭제

================================================================================
4. 데이터 관리
================================================================================

4.1 데이터 저장
- 암호화된 서버에 저장
- 백업 시스템 운영

4.2 데이터 보존 기간
- 연구 완료 후 5년간 보존
- 이후 완전 삭제

4.3 데이터 공유
- 익명화된 데이터만 공유
- 연구 목적으로만 사용

================================================================================
5. 연구 기간 및 일정
================================================================================

연구 기간: {study_duration_months}개월
참가자 수: {participant_count}명

================================================================================
6. 예상 결과
================================================================================

- 시뮬레이션 시스템의 민감도/특이도 계산
- 전문의 평가와의 일치도 분석
- 정상 참조군과의 비교 결과

================================================================================
7. 참고 문헌
================================================================================

- DSM-5: Diagnostic and Statistical Manual of Mental Disorders, 5th Edition
- ICD-11: International Classification of Diseases, 11th Revision
- 관련 ADHD 평가 도구 연구 문헌

================================================================================
"""
        return protocol
    
    def generate_consent_form(self,
                             study_title: str,
                             institution: str) -> str:
        """
        동의서 템플릿 생성
        
        Args:
            study_title: 연구 제목
            institution: 소속 기관
        
        Returns:
            동의서 텍스트
        """
        consent = f"""
================================================================================
연구 참여 동의서 (Informed Consent Form)
================================================================================

연구 제목: {study_title}
소속 기관: {institution}
작성 일자: {datetime.now().strftime('%Y-%m-%d')}

================================================================================
연구 설명
================================================================================

귀하는 ADHD 시뮬레이션 시스템 검증 연구에 참여하도록 초대되었습니다.

본 연구는:
- ADHD 평가를 위한 시뮬레이션 시스템의 정확도를 검증하는 연구입니다
- 연구 목적으로만 사용되며, 의학적 진단을 제공하지 않습니다
- 최소 위험 연구입니다

================================================================================
연구 절차
================================================================================

1. 기본 정보 수집 (연령, 성별 등)
2. ADHD 시뮬레이션 실행 (약 10-15분 소요)
3. 전문의 평가 (독립적으로 수행)
4. 결과 비교 분석

================================================================================
위험 및 이익
================================================================================

위험:
- 최소 위험 (Minimal Risk)
- 개인정보 유출 위험 (보호 조치 적용)

이익:
- 직접적 이익 없음
- 사회적 이익: ADHD 평가 도구 개발

================================================================================
개인정보 보호
================================================================================

- 모든 데이터는 익명화되어 저장됩니다
- 연구 목적으로만 사용됩니다
- 연구 완료 후 5년간 보존 후 삭제됩니다

================================================================================
동의 철회
================================================================================

- 언제든지 동의를 철회할 수 있습니다
- 동의 철회 시 수집된 데이터는 즉시 삭제됩니다
- 동의 철회는 연구 결과에 영향을 주지 않습니다

================================================================================
문의
================================================================================

연구 관련 문의사항이 있으시면 연구 책임자에게 연락하시기 바랍니다.

================================================================================
동의서
================================================================================

본인은 위 연구 설명을 충분히 이해하였으며, 자발적으로 본 연구에 참여하기로 동의합니다.

참가자 이름: ___________________
서명: ___________________
날짜: ___________________

연구 책임자 이름: ___________________
서명: ___________________
날짜: ___________________

================================================================================
"""
        return consent
    
    def generate_data_protection_plan(self) -> str:
        """
        데이터 보호 계획서 생성
        
        Returns:
            데이터 보호 계획서 텍스트
        """
        plan = f"""
================================================================================
데이터 보호 계획서 (Data Protection Plan)
================================================================================

작성 일자: {datetime.now().strftime('%Y-%m-%d')}

================================================================================
1. 데이터 수집 원칙
================================================================================

1.1 최소 수집 원칙
- 연구 목적에 필요한 최소한의 데이터만 수집
- 불필요한 개인정보 수집 금지

1.2 동의 기반 수집
- 명시적 동의 없이 데이터 수집 금지
- 동의 철회 시 즉시 삭제

================================================================================
2. 데이터 익명화
================================================================================

2.1 식별 정보 제거
- 이름, 주소, 전화번호 등 직접 식별 정보 제거
- 고유 식별자 사용 (UUID)

2.2 재식별 방지
- 익명화된 데이터의 재식별 불가능 보장
- 추가 정보와의 연결 차단

================================================================================
3. 데이터 저장 및 보안
================================================================================

3.1 암호화
- 전송 중 암호화 (TLS/SSL)
- 저장 시 암호화 (AES-256)

3.2 접근 제어
- 최소 권한 원칙
- 접근 로그 기록
- 정기적 접근 권한 검토

3.3 물리적 보안
- 서버실 접근 제한
- 백업 미디어 안전 보관

================================================================================
4. 데이터 보존 및 삭제
================================================================================

4.1 보존 기간
- 연구 완료 후 5년간 보존
- 법적 요구사항 준수

4.2 삭제 절차
- 보존 기간 만료 시 완전 삭제
- 백업 데이터 포함 완전 삭제
- 삭제 증명서 발급

================================================================================
5. 데이터 공유
================================================================================

5.1 공유 원칙
- 익명화된 데이터만 공유
- 연구 목적으로만 사용
- 추가 동의 없이 제3자 공유 금지

5.2 국제 전송
- GDPR 등 국제 규정 준수
- 적절한 보호 조치 적용

================================================================================
6. 데이터 주체 권리
================================================================================

6.1 접근 권리
- 본인의 데이터 접근 요청 가능
- 30일 이내 응답

6.2 수정 권리
- 잘못된 데이터 수정 요청 가능

6.3 삭제 권리
- 동의 철회 시 데이터 삭제 요청 가능

================================================================================
7. 침해 대응
================================================================================

7.1 침해 감지
- 정기적 보안 감사
- 이상 징후 모니터링

7.2 침해 대응
- 72시간 이내 관련 기관 신고
- 영향받은 개인 통지
- 재발 방지 조치

================================================================================
"""
        return plan
    
    def save_all_documents(self,
                          principal_investigator: str,
                          institution: str,
                          study_title: str) -> Dict[str, Path]:
        """
        모든 IRB 문서 저장
        
        Args:
            principal_investigator: 연구 책임자
            institution: 소속 기관
            study_title: 연구 제목
        
        Returns:
            저장된 파일 경로 딕셔너리
        """
        files = {}
        
        # 연구 계획서
        protocol = self.generate_research_protocol(
            principal_investigator, institution, study_title
        )
        protocol_path = self.output_dir / 'research_protocol.md'
        protocol_path.write_text(protocol, encoding='utf-8')
        files['protocol'] = protocol_path
        
        # 동의서
        consent = self.generate_consent_form(study_title, institution)
        consent_path = self.output_dir / 'informed_consent_form.md'
        consent_path.write_text(consent, encoding='utf-8')
        files['consent'] = consent_path
        
        # 데이터 보호 계획서
        data_plan = self.generate_data_protection_plan()
        data_plan_path = self.output_dir / 'data_protection_plan.md'
        data_plan_path.write_text(data_plan, encoding='utf-8')
        files['data_protection'] = data_plan_path
        
        return files

